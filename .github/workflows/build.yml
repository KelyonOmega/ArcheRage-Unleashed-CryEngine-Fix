name: Build ArcheRage-Unleashed-CryEngine-Fix Installer

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    # Build C# Detector
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '6.0.x'
    
    - name: Restore dependencies
      working-directory: ./installer
      run: dotnet restore Checking.CPU.RAM.GPU.csproj
    
    - name: Build detector
      working-directory: ./installer
      run: dotnet build Checking.CPU.RAM.GPU.csproj -c Release --no-restore
    
    - name: Copy EXE to installer directory
      run: |
        Copy-Item "installer/bin/Release/net6.0/Checking.CPU.RAM.GPU.exe" "installer/Checking.CPU.RAM.GPU.exe" -Force
      shell: powershell
    
    - name: Verify EXE exists
      run: |
        if (Test-Path "installer/Checking.CPU.RAM.GPU.exe") {
          Write-Host "✓ EXE found"
        } else {
          Write-Error "✗ EXE not found!"
          exit 1
        }
      shell: powershell
    
    # Install Inno Setup
    - name: Install Inno Setup
      run: |
        choco install innosetup -y
      shell: powershell
    
    - name: Verify Inno Setup
      run: |
        $iscc = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
        if (Test-Path $iscc) {
          Write-Host "✓ Inno Setup found"
        } else {
          Write-Error "✗ Inno Setup not found!"
          exit 1
        }
      shell: powershell
    
    # Build Installer
    - name: Build installer with Inno Setup
      working-directory: ./installer
      run: |
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "Kelyons_CryEngineFix_Final.iss"
      shell: powershell
    
    - name: Verify installer was created
      run: |
        if (Test-Path "installer/Output/CryEngineFixInstaller.exe") {
          Write-Host "✓ Installer created successfully"
        } else {
          Write-Error "✗ Installer not found!"
          exit 1
        }
      shell: powershell
    
    # Upload as artifact
    - name: Upload installer
      uses: actions/upload-artifact@v3
      with:
        name: CryEngineFixInstaller
        path: installer/Output/CryEngineFixInstaller.exe
    
    # Create release (only on tag push)
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: installer/Output/CryEngineFixInstaller.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
